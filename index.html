<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>音楽コード役割アナライザー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .tonic {
        background-color: #e0f2fe;
        border-color: #38bdf8;
      }
      .subdominant {
        background-color: #ecfdf5;
        border-color: #34d399;
      }
      .dominant {
        background-color: #fff1f2;
        border-color: #fb7185;
      }
      .tonic-text {
        color: #0c4a6e;
      }
      .subdominant-text {
        color: #065f46;
      }
      .dominant-text {
        color: #9f1239;
      }
      .tonic-border {
        border-left-color: #38bdf8;
      }
      .subdominant-border {
        border-left-color: #34d399;
      }
      .dominant-border {
        border-left-color: #fb7185;
      }

      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
      <!-- Header -->
      <header class="text-center mb-6">
        <h1 class="text-2xl sm:text-4xl font-bold text-slate-900">
          コード役割アナライザー
        </h1>
        <p class="mt-2 text-sm sm:text-base text-slate-600">
          キーに合わせた正しい構成音（異名同音）で表示します
        </p>
      </header>

      <!-- Controls -->
      <div
        class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6 sticky top-2 z-10 ring-1 ring-slate-900/5"
      >
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              for="key-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >キー (Root)</label
            >
            <select
              id="key-select"
              class="w-full bg-slate-100 border border-slate-200 rounded-lg p-2.5 text-base font-semibold focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition shadow-sm"
            >
              <!-- Options generated by JS -->
            </select>
          </div>
          <div>
            <label
              for="scale-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >スケール</label
            >
            <select
              id="scale-select"
              class="w-full bg-slate-100 border border-slate-200 rounded-lg p-2.5 text-base font-semibold focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition shadow-sm"
            >
              <option value="major">メジャー (Major)</option>
              <option value="minor">マイナー (Natural Minor)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Pentatonic Scale Display -->
      <div
        class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-8"
      >
        <h2
          class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-3"
        >
          ペンタトニックスケール (構成音)
        </h2>
        <div id="pentatonic-scale-container" class="flex flex-wrap gap-2">
          <!-- Scale notes will be generated by JS -->
        </div>
      </div>

      <!-- Chord Display -->
      <main>
        <div
          id="chord-container"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- Chord cards will be generated by JS -->
        </div>
      </main>

      <!-- Footer -->
      <footer class="text-center mt-12 text-slate-400 text-xs">
        <p>Enharmonic Spelling Aware Version</p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const keySelect = document.getElementById("key-select");
        const scaleSelect = document.getElementById("scale-select");
        const chordContainer = document.getElementById("chord-container");
        const pentatonicContainer = document.getElementById(
          "pentatonic-scale-container"
        );

        // 音名データ（クロマチック）
        const SHARP_NOTES = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];
        const FLAT_NOTES = [
          "C",
          "Db",
          "D",
          "Eb",
          "E",
          "F",
          "Gb",
          "G",
          "Ab",
          "A",
          "Bb",
          "B",
        ];

        // ドロップダウン用リスト (valueは半音のインデックス 0-11)
        const KEY_OPTIONS = [
          { val: 0, label: "C" },
          { val: 1, label: "C# / Db" },
          { val: 2, label: "D" },
          { val: 3, label: "Eb / D#" },
          { val: 4, label: "E" },
          { val: 5, label: "F" },
          { val: 6, label: "F# / Gb" },
          { val: 7, label: "G" },
          { val: 8, label: "Ab / G#" },
          { val: 9, label: "A" },
          { val: 10, label: "Bb / A#" },
          { val: 11, label: "B" },
        ];

        const SCALES = {
          major: {
            intervals: [0, 2, 4, 5, 7, 9, 11],
            pentatonicIntervals: [0, 2, 4, 7, 9],
            qualities: [
              "major",
              "minor",
              "minor",
              "major",
              "major",
              "minor",
              "diminished",
            ],
            roman: ["I", "ii", "iii", "IV", "V", "vi", "vii°"],
            functions: [
              { name: "トニック", type: "tonic", description: "安定・終止" },
              {
                name: "サブドミナント・マイナー",
                type: "subdominant",
                description: "SDの代理 (Jazz等)",
              },
              {
                name: "トニック・マイナー",
                type: "tonic",
                description: "Tの代理",
              },
              {
                name: "サブドミナント",
                type: "subdominant",
                description: "展開・発展",
              },
              {
                name: "ドミナント",
                type: "dominant",
                description: "緊張・解決へ",
              },
              {
                name: "トニック・マイナー",
                type: "tonic",
                description: "Tの代理 (平行調の主音)",
              },
              {
                name: "ドミナント代理",
                type: "dominant",
                description: "Dの代理",
              },
            ],
          },
          minor: {
            // Natural Minor (Aeolian)
            intervals: [0, 2, 3, 5, 7, 8, 10],
            pentatonicIntervals: [0, 3, 5, 7, 10],
            qualities: [
              "minor",
              "diminished",
              "major",
              "minor",
              "minor",
              "major",
              "major",
            ],
            roman: ["i", "ii°", "III", "iv", "v", "VI", "VII"],
            functions: [
              { name: "トニック", type: "tonic", description: "安定・終止" },
              {
                name: "サブドミナント代理",
                type: "subdominant",
                description: "緊張感のある代理",
              },
              {
                name: "トニック代理",
                type: "tonic",
                description: "平行調の主音(明るい)",
              },
              {
                name: "サブドミナント",
                type: "subdominant",
                description: "展開・発展",
              },
              {
                name: "ドミナント(小)",
                type: "dominant",
                description: "緊張(弱)。和声的短音階ではV7",
              },
              {
                name: "サブドミナント代理",
                type: "subdominant",
                description: "SDの代理 (暗→明)",
              },
              {
                name: "ドミナント代理",
                type: "dominant",
                description: "Dの代理 (♭VII)",
              },
            ],
          },
        };

        function init() {
          KEY_OPTIONS.forEach((opt) => {
            const option = document.createElement("option");
            option.value = opt.val;
            option.textContent = opt.label;
            keySelect.appendChild(option);
          });

          keySelect.value = "0"; // C
          scaleSelect.value = "major";
          generateChords();

          keySelect.addEventListener("change", generateChords);
          scaleSelect.addEventListener("change", generateChords);
        }

        // フラット系のキーかどうかを判定するロジック
        function shouldUseFlats(rootIndex, scaleType) {
          // インデックス: 0:C, 1:C#/Db, 2:D, 3:Eb, 4:E, 5:F, 6:F#, 7:G, 8:Ab, 9:A, 10:Bb, 11:B

          if (scaleType === "major") {
            // メジャーキーでフラットを使う主なキー: F(5), Bb(10), Eb(3), Ab(8), Db(1), Gb(6)
            const flatKeys = [5, 10, 3, 8, 1, 6];
            return flatKeys.includes(rootIndex);
          } else {
            // マイナーキーでフラットを使う主なキー: Dm(2), Gm(7), Cm(0), Fm(5), Bbm(10), Ebm(3)
            const flatKeys = [2, 7, 0, 5, 10, 3];
            return flatKeys.includes(rootIndex);
          }
        }

        function getNoteName(index, useFlats) {
          const normalizedIndex = index % 12;
          return useFlats
            ? FLAT_NOTES[normalizedIndex]
            : SHARP_NOTES[normalizedIndex];
        }

        function getChordName(rootNote, quality) {
          switch (quality) {
            case "major":
              return rootNote;
            case "minor":
              return `${rootNote}m`;
            case "diminished":
              return `${rootNote}dim`;
            default:
              return rootNote;
          }
        }

        function generateChords() {
          const rootIndex = parseInt(keySelect.value);
          const selectedScale = scaleSelect.value;
          const scaleInfo = SCALES[selectedScale];

          // フラット表記を使うべきか判定
          const useFlats = shouldUseFlats(rootIndex, selectedScale);

          chordContainer.innerHTML = "";
          pentatonicContainer.innerHTML = "";

          // Generate Chords
          scaleInfo.intervals.forEach((interval, index) => {
            const noteIndex = rootIndex + interval;
            const rootNote = getNoteName(noteIndex, useFlats);
            const quality = scaleInfo.qualities[index];
            const chordName = getChordName(rootNote, quality);
            const romanNumeral = scaleInfo.roman[index];
            const func = scaleInfo.functions[index];

            const card = `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden border-l-4 ${func.type}-border hover:shadow-md transition-shadow">
                            <div class="p-4">
                                <div class="flex justify-between items-baseline mb-2">
                                    <span class="text-2xl font-bold ${func.type}-text">${chordName}</span>
                                    <span class="text-sm font-medium text-slate-400 font-mono">${romanNumeral}</span>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${func.type} ${func.type}-text uppercase tracking-wide border border-current opacity-70">${func.type}</span>
                                        <span class="text-sm font-bold text-slate-700">${func.name}</span>
                                    </div>
                                    <p class="text-xs text-slate-500 leading-relaxed">${func.description}</p>
                                </div>
                            </div>
                        </div>
                    `;
            chordContainer.innerHTML += card;
          });

          // Generate Pentatonic
          if (scaleInfo.pentatonicIntervals) {
            scaleInfo.pentatonicIntervals.forEach((interval) => {
              const noteIndex = rootIndex + interval;
              const noteName = getNoteName(noteIndex, useFlats);

              const noteChip = document.createElement("span");
              noteChip.className =
                "px-3 py-1.5 bg-slate-100 text-slate-700 text-sm font-bold rounded-md border border-slate-200";
              noteChip.textContent = noteName;
              pentatonicContainer.appendChild(noteChip);
            });
          }
        }

        init();
      });
    </script>
  </body>
</html>
